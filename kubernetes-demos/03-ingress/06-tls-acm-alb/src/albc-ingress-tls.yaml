# ALB Ingress — Host-Based Routing with TLS (ACM)
#
# Extends Demo-05 host-based routing with HTTPS termination.
# Changes from Demo-05 albc-ingress-host-based.yaml:
#   + certificate-arn   → attaches ACM wildcard cert to HTTPS listener
#   + listen-ports      → opens both HTTP:80 and HTTPS:443 listeners
#   + ssl-redirect      → port 80 redirects all traffic to HTTPS:443 (HTTP 301)
#   + ssl-policy        → TLS 1.3 + TLS 1.2 policy (AWS recommended for production)
#
# TLS termination happens at the ALB.
# Traffic from ALB to pods is plain HTTP — no certificate management inside cluster.
#
# IMPORTANT: Replace CERT_ARN_PLACEHOLDER with your actual ACM certificate ARN.
# Get it with:
#   aws acm list-certificates \
#     --query "CertificateSummaryList[?DomainName=='*.rselvantech.com'].CertificateArn" \
#     --output text
# ---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: host-based-tls
  namespace: otel-demo
  annotations:
    # --- Ingress controller selection ---
    # Use spec.ingressClassName (preferred) over deprecated kubernetes.io/ingress.class annotation
    # kubernetes.io/ingress.class: alb  ← deprecated, avoid

    # --- ALB configuration ---
    alb.ingress.kubernetes.io/scheme: internet-facing          # public ALB
    alb.ingress.kubernetes.io/target-type: ip                  # route directly to pod IPs (requires VPC CNI)

    # --- Grouping (shares existing ALB from Demo-05) ---
    alb.ingress.kubernetes.io/group.name: host-routing         # reuses same ALB as Demo-05

    # --- TLS configuration ---
    # ACM wildcard certificate ARN — covers *.rselvantech.com
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-2:165015980598:certificate/bc560546-1916-4b6b-b3fb-ad5c62d13e68

    # Open both HTTP (80) and HTTPS (443) listeners on the ALB
    # Both are required: 443 serves real traffic, 80 exists only to redirect to HTTPS
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'

    # Redirect all HTTP (port 80) traffic to HTTPS (port 443) with HTTP 301
    # ALB Controller creates the redirect rule automatically — no JSON action needed
    alb.ingress.kubernetes.io/ssl-redirect: "443"

    # TLS security policy — TLS 1.3 + TLS 1.2 backwards compatible
    # ELBSecurityPolicy-TLS13-1-2-2021-06 is the AWS recommended policy for production
    # Supports TLS 1.3 (preferred) and TLS 1.2 (for older clients)
    # Does NOT support TLS 1.1 or TLS 1.0 (insecure, deprecated)
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS13-1-2-2021-06

    # --- Health checks ---
    # All 3 services respond on / — Grafana returns 301 redirect (within 200-399 range)
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/success-codes: "200-399"

    # --- DNS (external-dns) ---
    # external-dns reads this annotation and creates Route53 ALIAS records
    # pointing each subdomain to the ALB hostname from .status.loadBalancer.ingress[0].hostname
    external-dns.alpha.kubernetes.io/hostname: app.rselvantech.com,grafana.rselvantech.com,jaeger.rselvantech.com

spec:
  ingressClassName: alb    # preferred over deprecated kubernetes.io/ingress.class annotation
  rules:
    # ---------------------------------------------------------------
    # app.rselvantech.com → frontend-proxy:8080
    # ---------------------------------------------------------------
    - host: app.rselvantech.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-proxy
                port:
                  number: 8080

    # ---------------------------------------------------------------
    # grafana.rselvantech.com → grafana:80
    # Grafana's root_url is set to https://grafana.rselvantech.com/grafana
    # in otel-demo-app-values.yaml — redirect Location header uses correct domain
    # ---------------------------------------------------------------
    - host: grafana.rselvantech.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 80

    # ---------------------------------------------------------------
    # jaeger.rselvantech.com → jaeger:16686
    # Jaeger serves static HTML on / with client-side JS redirect to /jaeger/ui/search
    # No server-side redirect — works with host-based routing without any config change
    # ---------------------------------------------------------------
    - host: jaeger.rselvantech.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: jaeger
                port:
                  number: 16686